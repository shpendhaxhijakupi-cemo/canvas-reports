name: Canvas → Airtable

on:
  workflow_dispatch:
    inputs:
      student_ids:
        description: "Comma-separated Canvas user IDs (e.g. 1643, 12345)"
        required: true
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      # Make Python logs stream immediately
      PYTHONUNBUFFERED: "1"
      DEBUG: "1"
      LOG_SCHEMA: "1"              # set to "0" to reduce noise
      # Set to "1" if you want unknown single-select values coerced to "Other"/first option
      ALLOW_SELECT_FALLBACK: "0"

      # Canvas (secrets)
      CANVAS_API_URL: ${{ secrets.CANVAS_API_URL }}
      CANVAS_ACCESS_TOKEN: ${{ secrets.CANVAS_ACCESS_TOKEN }}
      CANVAS_ACCOUNT_ID: ${{ secrets.CANVAS_ACCOUNT_ID }} # optional; defaults to 1 if not set

      # Airtable (secrets)
      AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}

      # Prefer table IDs (tbl...) if you have them; names used only if IDs are missing
      AIRTABLE_DETAILED_TABLE_ID: ${{ secrets.AIRTABLE_DETAILED_TABLE_ID }}
      AIRTABLE_SUMMARY_TABLE_ID:  ${{ secrets.AIRTABLE_SUMMARY_TABLE_ID }}
      AIRTABLE_DETAILED_TABLE:    ${{ secrets.AIRTABLE_DETAILED_TABLE }}   # e.g. Phoenix Student Assignment Details
      AIRTABLE_SUMMARY_TABLE:     ${{ secrets.AIRTABLE_SUMMARY_TABLE }}    # e.g. Phoenix Christian Course Details

      # Optional pacing
      SLEEP_BETWEEN_REQUESTS: "0.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi
          # Ensure required libs are present (pyairtable v2.x + requests)
          python - <<'PY'
          import pkgutil, sys, subprocess
          need = []
          for mod in [("pyairtable", "pyairtable==2.*"), ("requests", "requests>=2.28")]:
              if pkgutil.find_loader(mod[0]) is None:
                  need.append(mod[1])
          if need:
              subprocess.check_call([sys.executable, "-m", "pip", "install", *need])
          PY

      - name: Show config targets (no secrets)
        run: |
          echo "Base: $AIRTABLE_BASE_ID"
          echo "Detailed table selector: ${AIRTABLE_DETAILED_TABLE_ID:-$AIRTABLE_DETAILED_TABLE}"
          echo "Summary  table selector: ${AIRTABLE_SUMMARY_TABLE_ID:-$AIRTABLE_SUMMARY_TABLE}"
          echo "Canvas account id: ${CANVAS_ACCOUNT_ID:-1}"
          echo "ALLOW_SELECT_FALLBACK=$ALLOW_SELECT_FALLBACK  LOG_SCHEMA=$LOG_SCHEMA  DEBUG=$DEBUG"

      - name: Run sync (Canvas → Airtable)
        shell: bash
        run: |
          set -euo pipefail
          python canvas_to_airtable.py << 'EOF'
          ${{ github.event.inputs.student_ids }}
          EOF
