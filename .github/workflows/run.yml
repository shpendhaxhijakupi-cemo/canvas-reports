name: Canvas → Airtable (All Partners)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'

jobs:
  # ================= Everything EXCEPT B2C (runs in parallel matrix) =================
  sync_rest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # No max-parallel here → runs partners in parallel
      matrix:
        partner:
          - phoenix
          - nhcc
          - southlands
          - nhcc_journey
          - nhcc_ironwood
          - nhcc_central
          - nhcc_grace
          - earl_franklin
          - odisea

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install requests pyairtable

      - name: Prepare partner env
        shell: bash
        env:
          CANVAS_API_URL:       ${{ secrets.CANVAS_API_URL }}
          CANVAS_ACCESS_TOKEN:  ${{ secrets.CANVAS_ACCESS_TOKEN }}
          AIRTABLE_API_KEY:     ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID:     ${{ secrets.AIRTABLE_BASE_ID }}

          # Phoenix
          AIRTABLE_DETAILED_TABLE_PHOENIX: ${{ secrets.AIRTABLE_DETAILED_TABLE }}
          AIRTABLE_SUMMARY_TABLE_PHOENIX:  ${{ secrets.AIRTABLE_SUMMARY_TABLE }}
          STUDENT_IDS_PHOENIX:             ${{ secrets.STUDENT_IDS_PHOENIX }}

          # NHCC (legacy, all-NHCC)
          AIRTABLE_DETAILED_TABLE_NHCC: ${{ secrets.AIRTABLE_DETAILED_NHCC_TABLE }}
          AIRTABLE_SUMMARY_TABLE_NHCC:  ${{ secrets.AIRTABLE_SUMMARY_NHCC_TABLE }}
          STUDENT_IDS_NHCC:             ${{ secrets.STUDENT_IDS_NHCC }}

          # Southlands
          AIRTABLE_DETAILED_TABLE_SOUTHLANDS: ${{ secrets.AIRTABLE_DETAILED_SOUTHLANDS_TABLE }}
          AIRTABLE_SUMMARY_TABLE_SOUTHLANDS:  ${{ secrets.AIRTABLE_SUMMARY_SOUTHLANDS_TABLE }}
          STUDENT_IDS_SOUTHLANDS:             ${{ secrets.STUDENT_IDS_SOUTHLANDS }}

          # NHCC Journey
          AIRTABLE_DETAILED_TABLE_NHCC_JOURNEY: ${{ secrets.AIRTABLE_DETAILED_NHCC_JOURNEY_TABLE }}
          AIRTABLE_SUMMARY_TABLE_NHCC_JOURNEY:  ${{ secrets.AIRTABLE_SUMMARY_NHCC_JOURNEY_TABLE }}
          STUDENT_IDS_NHCC_JOURNEY:             ${{ secrets.STUDENT_IDS_NHCC_JOURNEY }}

          # NHCC Ironwood
          AIRTABLE_DETAILED_TABLE_NHCC_IRONWOOD: ${{ secrets.AIRTABLE_DETAILED_NHCC_IRONWOOD_TABLE }}
          AIRTABLE_SUMMARY_TABLE_NHCC_IRONWOOD:  ${{ secrets.AIRTABLE_SUMMARY_NHCC_IRONWOOD_TABLE }}
          STUDENT_IDS_NHCC_IRONWOOD:             ${{ secrets.STUDENT_IDS_NHCC_IRONWOOD }}

          # NHCC Central
          AIRTABLE_DETAILED_TABLE_NHCC_CENTRAL: ${{ secrets.AIRTABLE_DETAILED_NHCC_CENTRAL_TABLE }}
          AIRTABLE_SUMMARY_TABLE_NHCC_CENTRAL:  ${{ secrets.AIRTABLE_SUMMARY_NHCC_CENTRAL_TABLE }}
          STUDENT_IDS_NHCC_CENTRAL:             ${{ secrets.STUDENT_IDS_NHCC_CENTRAL }}

          # NHCC Grace
          AIRTABLE_DETAILED_TABLE_NHCC_GRACE: ${{ secrets.AIRTABLE_DETAILED_NHCC_GRACE_TABLE }}
          AIRTABLE_SUMMARY_TABLE_NHCC_GRACE:  ${{ secrets.AIRTABLE_SUMMARY_NHCC_GRACE_TABLE }}
          STUDENT_IDS_NHCC_GRACE:             ${{ secrets.STUDENT_IDS_NHCC_GRACE }}

          # Earl Franklin
          AIRTABLE_DETAILED_TABLE_EARL_FRANKLIN: ${{ secrets.AIRTABLE_DETAILED_EARL_FRANKLIN_TABLE }}
          AIRTABLE_SUMMARY_TABLE_EARL_FRANKLIN:  ${{ secrets.AIRTABLE_SUMMARY_EARL_FRANKLIN_TABLE }}
          STUDENT_IDS_EARL_FRANKLIN:             ${{ secrets.STUDENT_IDS_EARL_FRANKLIN }}

          # Odisea
          AIRTABLE_DETAILED_TABLE_ODISEA: ${{ secrets.AIRTABLE_DETAILED_ODISEA_TABLE }}
          AIRTABLE_SUMMARY_TABLE_ODISEA:  ${{ secrets.AIRTABLE_SUMMARY_ODISEA_TABLE }}
          STUDENT_IDS_ODISEA:             ${{ secrets.STUDENT_IDS_ODISEA }}
        run: |
          set -euo pipefail
          echo "CANVAS_API_URL=${CANVAS_API_URL}"           >> "$GITHUB_ENV"
          echo "CANVAS_ACCESS_TOKEN=${CANVAS_ACCESS_TOKEN}" >> "$GITHUB_ENV"
          echo "AIRTABLE_API_KEY=${AIRTABLE_API_KEY}"       >> "$GITHUB_ENV"
          echo "AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}"       >> "$GITHUB_ENV"

          case "${{ matrix.partner }}" in
            phoenix)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_PHOENIX}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_PHOENIX}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_PHOENIX}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=Phoenix"                                       >> "$GITHUB_ENV"
              ;;
            nhcc)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_NHCC}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_NHCC}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_NHCC}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=NHCC"                                       >> "$GITHUB_ENV"
              ;;
            southlands)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_SOUTHLANDS}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_SOUTHLANDS}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_SOUTHLANDS}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=Southlands"                                       >> "$GITHUB_ENV"
              ;;
            nhcc_journey)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_NHCC_JOURNEY}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_NHCC_JOURNEY}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_NHCC_JOURNEY}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=NHCC_Journey"                                       >> "$GITHUB_ENV"
              ;;
            nhcc_ironwood)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_NHCC_IRONWOOD}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_NHCC_IRONWOOD}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_NHCC_IRONWOOD}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=NHCC_Ironwood"                                       >> "$GITHUB_ENV"
              ;;
            nhcc_central)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_NHCC_CENTRAL}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_NHCC_CENTRAL}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_NHCC_CENTRAL}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=NHCC_Central"                                       >> "$GITHUB_ENV"
              ;;
            nhcc_grace)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_NHCC_GRACE}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_NHCC_GRACE}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_NHCC_GRACE}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=NHCC_Grace"                                        >> "$GITHUB_ENV"
              ;;
            earl_franklin)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_EARL_FRANKLIN}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_EARL_FRANKLIN}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_EARL_FRANKLIN}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=Earl_Franklin"                                       >> "$GITHUB_ENV"
              ;;
            odisea)
              echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_ODISEA}" >> "$GITHUB_ENV"
              echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_ODISEA}"   >> "$GITHUB_ENV"
              echo "STUDENT_USER_IDS=${STUDENT_IDS_ODISEA}"                    >> "$GITHUB_ENV"
              echo "PARTNER_NAME=Odisea"                                       >> "$GITHUB_ENV"
              ;;
          esac

      - name: Validate env
        shell: bash
        run: |
          test -n "${AIRTABLE_DETAILED_TABLE}" || { echo "::error ::AIRTABLE_DETAILED_TABLE empty"; exit 1; }
          test -n "${AIRTABLE_SUMMARY_TABLE}"  || { echo "::error ::AIRTABLE_SUMMARY_TABLE empty";  exit 1; }
          test -n "${STUDENT_USER_IDS}"        || { echo "::error ::STUDENT_USER_IDS empty";        exit 1; }

      - name: Run sync
        env:
          DEBUG: "1"
          LOG_SCHEMA: "1"
          ALLOW_SELECT_FALLBACK: "0"
          SLEEP_BETWEEN_REQUESTS: "0.0"
          PYTHONUNBUFFERED: "1"
        run: python canvas_to_airtable.py

  # ================= B2C Part 1 (wipes) =================
  b2c_p1:
    runs-on: ubuntu-latest
    # No 'needs' → runs in parallel with sync_rest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install requests pyairtable

      - name: Prepare env (B2C_P1)
        shell: bash
        env:
          CANVAS_API_URL:       ${{ secrets.CANVAS_API_URL }}
          CANVAS_ACCESS_TOKEN:  ${{ secrets.CANVAS_ACCESS_TOKEN }}
          AIRTABLE_API_KEY:     ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID:     ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_DETAILED_TABLE_B2C: ${{ secrets.AIRTABLE_DETAILED_B2C_TABLE }}
          AIRTABLE_SUMMARY_TABLE_B2C:  ${{ secrets.AIRTABLE_SUMMARY_B2C_TABLE }}
          STUDENT_IDS_B2C_P1:          ${{ secrets.STUDENT_IDS_B2C_P1 }}
        run: |
          set -euo pipefail
          echo "CANVAS_API_URL=${CANVAS_API_URL}"           >> "$GITHUB_ENV"
          echo "CANVAS_ACCESS_TOKEN=${CANVAS_ACCESS_TOKEN}" >> "$GITHUB_ENV"
          echo "AIRTABLE_API_KEY=${AIRTABLE_API_KEY}"       >> "$GITHUB_ENV"
          echo "AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}"       >> "$GITHUB_ENV"
          echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_B2C}" >> "$GITHUB_ENV"
          echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_B2C}"   >> "$GITHUB_ENV"
          echo "STUDENT_USER_IDS=${STUDENT_IDS_B2C_P1}"                 >> "$GITHUB_ENV"
          echo "PARTNER_NAME=B2C_P1"                                    >> "$GITHUB_ENV"

      - name: Validate env
        shell: bash
        run: |
          test -n "${AIRTABLE_DETAILED_TABLE}" || { echo "::error ::AIRTABLE_DETAILED_TABLE empty"; exit 1; }
          test -n "${AIRTABLE_SUMMARY_TABLE}"  || { echo "::error ::AIRTABLE_SUMMARY_TABLE empty";  exit 1; }
          test -n "${STUDENT_USER_IDS}"        || { echo "::error ::STUDENT_USER_IDS empty";        exit 1; }

      - name: Run B2C_P1
        env:
          DEBUG: "1"
          LOG_SCHEMA: "1"
          ALLOW_SELECT_FALLBACK: "0"
          SLEEP_BETWEEN_REQUESTS: "0.0"
          PYTHONUNBUFFERED: "1"
        run: python canvas_to_airtable.py

  # ================= B2C Part 2 (append only; waits for P1) =================
  b2c_p2:
    runs-on: ubuntu-latest
    needs: [b2c_p1]   # enforce order ONLY for B2C
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install requests pyairtable

      - name: Prepare env (B2C_P2)
        shell: bash
        env:
          CANVAS_API_URL:       ${{ secrets.CANVAS_API_URL }}
          CANVAS_ACCESS_TOKEN:  ${{ secrets.CANVAS_ACCESS_TOKEN }}
          AIRTABLE_API_KEY:     ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID:     ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_DETAILED_TABLE_B2C: ${{ secrets.AIRTABLE_DETAILED_B2C_TABLE }}
          AIRTABLE_SUMMARY_TABLE_B2C:  ${{ secrets.AIRTABLE_SUMMARY_B2C_TABLE }}
          STUDENT_IDS_B2C_P2:          ${{ secrets.STUDENT_IDS_B2C_P2 }}
        run: |
          set -euo pipefail
          echo "CANVAS_API_URL=${CANVAS_API_URL}"           >> "$GITHUB_ENV"
          echo "CANVAS_ACCESS_TOKEN=${CANVAS_ACCESS_TOKEN}" >> "$GITHUB_ENV"
          echo "AIRTABLE_API_KEY=${AIRTABLE_API_KEY}"       >> "$GITHUB_ENV"
          echo "AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}"       >> "$GITHUB_ENV"
          echo "AIRTABLE_DETAILED_TABLE=${AIRTABLE_DETAILED_TABLE_B2C}" >> "$GITHUB_ENV"
          echo "AIRTABLE_SUMMARY_TABLE=${AIRTABLE_SUMMARY_TABLE_B2C}"   >> "$GITHUB_ENV"
          echo "STUDENT_USER_IDS=${STUDENT_IDS_B2C_P2}"                 >> "$GITHUB_ENV"
          echo "PARTNER_NAME=B2C_P2"                                    >> "$GITHUB_ENV"

      - name: Validate env
        shell: bash
        run: |
          test -n "${AIRTABLE_DETAILED_TABLE}" || { echo "::error ::AIRTABLE_DETAILED_TABLE empty"; exit 1; }
          test -n "${AIRTABLE_SUMMARY_TABLE}"  || { echo "::error ::AIRTABLE_SUMMARY_TABLE empty";  exit 1; }
          test -n "${STUDENT_USER_IDS}"        || { echo "::error ::STUDENT_USER_IDS empty";        exit 1; }

      - name: Run B2C_P2
        env:
          DEBUG: "1"
          LOG_SCHEMA: "1"
          ALLOW_SELECT_FALLBACK: "0"
          SLEEP_BETWEEN_REQUESTS: "0.0"
          PYTHONUNBUFFERED: "1"
        run: python canvas_to_airtable.py
